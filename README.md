# Flash Sales Market
## 프로젝트 소개
일반 상품 판매와 **지정된 시간에 오픈되는 선착순 이벤트 상품 판매 기능**을 제공하는 이커머스 플랫폼입니다.

대용량 트래픽 처리 및 동시성 제어 방법을 학습하고 **MSA와 분산 락을 적용**한 개인 프로젝트입니다.

**기간**: 2024.10.18 ~ 2024.11.19 (1차)

**인원**: 1명

## 개발 환경

```
[Backend]
- Java 21
- Spring Boot 3.3.4
- Spring Cloud 2023.0.3
- Spring Data JPA / QueryDSL 5.1.0

[Database]
- MySQL 9.1
- Redis 7.4

[Infrastructure]
- Docker / Docker Compose
- Apache Kafka 3.9
```
## 시스템 아키텍처
![FlashSalesMarket 아키텍처](https://github.com/user-attachments/assets/416efe76-034e-4119-85ae-960b4c76226c)
## ERD
## API 명세
## 핵심 기능
### 1. 아키텍처 선택 배경
- 주문 및 결제 등 트래픽이 집중되는 서비스를 독립적으로 확장할 수 있도록 **MSA 구조로 설계**하였으며, 여러 서비스를 하나의 프로젝트로 관리하기 위해 멀티모듈로 구성된 **모노레포 구조를 채택**했습니다.
### 2. 서비스 디스커버리 패턴 적용 및 API Gateway 구축
- **Netflix Eureka**를 통해 각 서비스의 동적 위치 정보를 자동으로 관리하여 서비스 추가 및 변경에 유연하게 대응하였고, **Spring Cloud Gateway**를 통해 클라이언트 요청을 단일 진입점에서 통합 관리하며 로드 밸런싱을 수행했습니다.
### 3. 상품 주문 시 재고 선점 방식 도입
- 선착순 구매 이벤트 중 주문 및 결제 플로우에서의 빈번한 재고 확인 요청으로 발생하는 **상품 서비스 부하와 성능 저하를 방지**하고, 결제 중 재고 부족으로 인한 취소가 **사용자에게 부정적 경험을 줄 것을 고려**해 주문 생성 시 상품 재고를 선점하는 방식을 도입했습니다.
- 주문 생성 시, **상품의 주문 수량을 DB의 선점 재고 테이블에 미리 할당**하고 **재고 확인 로직에서는 (상품의 실제 재고 수량) - (선점된 재고 수량)으로 가용 재고를 확인**합니다. 결제에 성공하면 선점된 재고가 확정적으로 차감되며, 실패하면 선점된 재고가 해제됩니다.
### 4. 이벤트 기반 통신을 통한 상태 변경
- **비동기 통신으로 응답 속도를 높이고 알림 서비스의 확장을 고려**해 이벤트 기반 통신을 적용했습니다.
- 결제 실패 시 주문 상태를 '실패'로 변경하고 선점된 재고를 해제하며, 결제 성공 시 주문 상태를 '완료'로 변경하고 선점된 재고를 확정 차감하는 로직을 이벤트 기반 통신으로 처리합니다.
- **결제 이벤트 발행을 트리거로 각각의 서비스에서 상태 변경이 이루어지며**, 주문 상태 및 상품 재고 상태의 일관성을 유지합니다.
### 5. 분산 락을 적용한 동시성 제어
- 상품 재고 선점과 확정 차감 과정에서 발생할 수 있는 동시성 문제를 해결하기 위해 **Redisson 분산 락을 적용**하고 테스트 코드로 검증하였습니다.
- 데드락을 고려해 **락을 획득하는 리소스의 순서를 정렬하여 교착 상태를 방지**했습니다.
- 비즈니스 로직과 분리하기 위해 **AOP를 적용하고, 커스텀 어노테이션을 통해 락을 획득하도록 구현**했습니다.
- 트랜잭션이 종료되기 전 락이 해제되어 동시성 제어가 안되는 문제가 있어 락 AOP가 트랜잭션 AOP보다 먼저 적용되도록 순서를 조정했습니다.
## 부하 테스트 및 성능 개선
목표: 다수 사용자 요청 시 API의 응답 시간과 TPS 평가

테스트 환경
- 도구: nGrinder + Docker
- 구성
  - Docker를 사용해 로컬 환경에서 nGrinder 컨테이너 실행
  - nGrinder Controller: cpu 1core memory 2G 할당
  - nGrinder Agent: cpu 2core memory 6G 할당
- 조건
  - 상품 수량: 상품 5000개의 재고를 100개로 설정.
  - 초기 VUser 수: 30명에서 시작하여 300명까지 점진적으로 증가.
  - Ramp-Up 방식으로 30초마다 30명씩 VUser 수를 증가.
  - 5분 동안 테스트 진행.

### 주문 생성 API

1차 테스트 결과 요약: TPS 평균 63.0 / 응답 시간 평균 2.6초

[테스트 지표](docs/TEST_RESULT.md)
