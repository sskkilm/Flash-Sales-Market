# 선착순 구매 전자상거래 플랫폼

## | 프로젝트 소개

**선착순 구매 서비스가 진행되는 전자상거래 플랫폼**을 설계하며,

MSA, Redis, Apache Kafka를 학습하고 이를 활용해 시스템 성능 최적화를 목표로 진행한 토이 프로젝트입니다.

대규모 트래픽 상황을 가정해 MSA를 도입하고, Redis와 Apache Kafka를 활용해 API 성능을 최적화 했습니다.

**기간**: 2024.10.18 ~ 2024.11.19 (MVP)

**인원**: BE 1명

## | 설치 방법

- 프로젝트 루트 디렉토리에서 실행

```
docker compose up -d
```

## | 개발 환경

```
[Backend]
- Java 21
- Spring Boot 3.3.4
- Spring Cloud 2023.0.3
- Spring Data JPA / QueryDSL 5.1.0

[Database]
- MySQL 9.1
- Redis 7.4

[Infrastructure]
- Docker / Docker Compose
- Apache Kafka 3.9
```

## | 시스템 아키텍처

## 서비스 별 기능 요약
### **1. Member Service**
- JWT 기반 회원가입 / 로그인
- Redis를 이용한 토큰 블랙리스트 관리로 로그아웃 구현

### **2. CartItem Service**
- 장바구니 항목 생성, 수정, 삭제, 조회, 장바구니 상품 기반 주문 생성

### **3. Product Service**
- 상품 목록 및 상세 정보 조회, 상품 재고 조회를 통한 주문 가능 상태 확인
- **Redis를 이용한 상품 재고 캐싱**

### **4. Order Service**
- 주문 생성, 주문 목록 조회, 주문 상태 관리 (결제 대기, 승인, 실패)
- **대규모 트래픽 상황에서 Redis를 활용한 실시간 상품 재고 관리**

### **5. Payment Service**
- 임시 결제 정보 저장, 결제 승인, 결제 내역 조회
- 토스 페이먼츠 API를 참고한 결제 흐름 구현
- **Apache Kafka를 통한 결제 이벤트 발행 및 비동기 처리**

### **6. API Gateway**
- JWT 디코딩 및 유효성 검사
- 요청 라우팅 및 로드 밸런싱

### **7. Service Registry**

- 서비스 동적 위치 정보 관리

## | ERD

## | API 명세

## | 핵심 기능

**기능 1**: API Gateway를 통한 클라이언트 요청 통합 관리, JWT 디코딩 및 로드밸런싱

**기능 2**: 상품 선착순 주문

**기능 3**: 결제를 통한 주문 상태 변경 및 상품 재고 동기화

## | 의사 결정

### 1. **MSA**
- 주문 및 결제 등 **트래픽이 집중되는 서비스를 독립적으로 확장 가능**
- 여러 서비스를 하나의 프로젝트로 관리하기 위해 **멀티모듈을 활용한 모노레포**로 구성

### 2. **Service Registry 구축 (Netflix Eureka)**
- **각 서비스의 동적 위치 정보를 자동으로 관리**하여 서비스 추가 / 변경에 대응 가능
- 각 서비스가 다른 언어와 프레임워크를 사용하는 경우, Apache Zookeeper와 같은 분산 코디네이션 서비스가 적합
- 현재 프로젝트는 모든 서비스가 Java, Spring Boot 기반으로 개발되어,
  **Spring Cloud에서 통합 지원하는 Netflix Eureka 사용**

### 3. **API Gateway 구축 (Spring Cloud Gateway)**
- **비동기 / Non-Blocking 방식**으로 스레드 점유 최소화 (Spring WebFlux 기반)
- **서비스 간 동기 통신**은 **API Gateway를 경유**하도록 설계하여 **보안 강화**

### 4. **Redis (In-memory DB)**
- 인메모리 기반으로 **빠른 처리 속도**
- 싱글 스레드로 동작. **동시성 제어 솔루션**으로도 활용 가능

### 5. **Apache Kafka (Event Broker)**
- 디스크 저장 기능을 활용해 비동기 처리 중 유실될 수 있는 결제 **이벤트 보존**
- 동일 토픽 내 메시지를 다수의 애플리케이션이 개별적으로 읽을 수 있어, 추후 알림 서비스 추가 시 **확장 용이**

## | 트러블 슈팅

### 상품 재고 차감 과정에서 발생하는 동시성 문제
[문제]
- Redis 명령어를 사용한 재고 변경 작업은 원자적으로 처리되므로 동시성 문제가 발생하지 않음
- 그러나 **재고 부족 여부를 애플리케이션 단에서 처리**하는 경우,
  다수의 요청이 동시에 재고를 확인할 수 있어 동시성 문제가 발생

[해결]
- 재고 부족 여부 확인과 차감 작업을 하나의 **Lua Script**로 묶어 원자적으로 처리
- 로직이 간단하고 별도의 락 메커니즘이 필요 없어 성능 측면에서 효율적이라 판단

### 동시성 관리 전략 비교

[**Lua Script**]
- 여러 연산을 하나의 원자적 연산으로 처리 가능. 별도의 락 메커니즘 불필요
- 복잡한 로직이나 예외 처리가 필요한 경우 구현 난이도 상승

[**분산 락**]
- 애플리케이션 레벨에서 명시적으로 락을 제어 (획득 및 해제)
- 락 획득을 위한 대기 시간이 발생하며, 데드락 방지를 위한 타임아웃 설정 필요
- MySQL (Named Lock)
  - 락 처리를 위한 커넥션 풀과 일반 DB 작업을 처리하는 커넥션 풀을 분리해야 함
- Redis (Redisson)
  - 임계 구역에서 RDB에 접근하는 로직이 포함된 경우, 트랜잭션 생명주기를 고려해야 함

## | 부하 테스트
### **트래픽 산정**
- e-commerce 평균 구매 전환율
  - 일반적인 e-commerce 서비스 방문자 중 실제 구매 전환율은 약 2%로 보고됨
  - 출처: https://www.oberlo.com/statistics/average-ecommerce-conversion-rate (**Average Ecommerce Conversion Rate (2023–2024)**)
- 선착순 구매 전환율 가정
  - 선착순 구매는 높은 구매 의도를 가진 사용자가 몰리는 상황, **구매 전환율 10%로 상향 조정**
  - 총 방문자 **10,000명**으로 가정
  - **구매 전환율 10%, 주문 성공률 10%로 가정**하고 예상 트래픽 산정
- 주문: 총 방문자 **10,000명 × 10% = 1,000명** 동시 진행
- 결제: 주문 사용자 **1,000명 × 10% = 100명** 동시 진행

### **테스트 환경**
- **Tool:** Apache JMeter
- **Server**: Local Docker Container (CPU 1core Memory 1G)

## | 성능 최적화
| API      | 응답 시간 (초) | TPS |
|----------| --- | --- |
| 주문 생성    | 7.1 → 2.6   (**63.4%** 개선) | 132 →   361  (**173.5%** 개선) |
| 상품 재고 조회 | 0.6 → 0.2   (**66.7%** 개선) | 1538 → 3460  (**125.0%** 개선) |
| 결제 승인    | 1.4 → 0.2   (**81.8%** 개선) | 65 →   358  (**450.8%** 개선) |

### **1. Redis를 활용한 데이터 처리**
[목표]
- 주문 생성, 상품 재고 조회 API에서 발생하는 MySQL의 **Disk I/O 병목 개선**

[개선 내용]
- **I/O 및 쿼리 최적화**
  - 서비스 간 통신에서 단건으로 여러 번 실행하던 네트워크 요청을 **일괄 요청**으로 수정
  - 단건으로 여러 번 조회하던 쿼리를 **일괄 조회 쿼리**로 수정하고, **필요한 컬럼만 선택적으로 추출**
- **Redis**에서 상품 재고 변경 및 조회
  - 캐시 미존재 시 MySQL에서 데이터 로드 및 Redis 캐싱
  - MySQL에서 조회하던 상품 재고를 Redis 캐시에서 조회
  - 주문에 의한 상품 재고 차감도 Redis에서 수행

[시뮬레이션]
- 10분 동안 1000명의 가상 사용자가 동시 접속하여 주문 요청

[성과]
- 주문 생성 API: 응답 시간: 7.1초 → 2.6초, TPS: 132 → 361
- 상품 재고 조회 API: - 응답 시간: 0.6초 → 0.2초, TPS: 1,538 → 3,460

### 2. **Apache Kafka를 활용한 비동기 처리**
[목표]
- 결제 승인 API에서 주문 서비스와의 **동기 통신으로 발생한 스레드 블로킹 개선**

[개선 내용]
- 결제 성공, 실패 Topic 구성. 결제 서비스에서 이벤트 발행
- 주문 서비스는 두 Topic을 구독하며 이벤트 처리. 주문 상태 변경 및 상품 재고 동기화

[시뮬레이션]
- 5분 동안 주문에 성공한 100명의 가상 사용자가 동시 접속하여 결제 요청

[성과]
- 결제 승인 API: 응답 시간: 1.4초 → 0.2초, TPS: 65 → 358